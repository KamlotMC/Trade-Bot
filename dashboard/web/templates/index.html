<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MEWC Trading Center</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="/static/css/main.css" />
</head>
<body>

<!-- Animated background layers -->
<div class="bg-mesh"></div>
<div class="bg-grid"></div>
<div class="bg-canvas"><canvas id="bgCanvas"></canvas></div>

<div class="app-wrapper">

  <!-- ── Header ── -->
  <header class="header">
    <div class="header-brand">
      <svg class="brand-logo" viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="22" cy="22" r="22" fill="url(#bg1)"/>
        <defs>
          <linearGradient id="bg1" x1="0" y1="0" x2="44" y2="44" gradientUnits="userSpaceOnUse">
            <stop offset="0%" stop-color="#ff6b00"/><stop offset="100%" stop-color="#ffcc00"/>
          </linearGradient>
        </defs>
        <!-- Cat ears -->
        <path d="M10 19 L14 10 L18 17" fill="rgba(255,255,255,0.85)"/>
        <path d="M34 19 L30 10 L26 17" fill="rgba(255,255,255,0.85)"/>
        <!-- Eyes -->
        <ellipse cx="18.5" cy="22" rx="2.5" ry="3" fill="white"/>
        <ellipse cx="25.5" cy="22" rx="2.5" ry="3" fill="white"/>
        <ellipse cx="19" cy="22.5" rx="1.2" ry="1.8" fill="#c44a00"/>
        <ellipse cx="26" cy="22.5" rx="1.2" ry="1.8" fill="#c44a00"/>
        <!-- Nose -->
        <path d="M20.5 26 L22 24.8 L23.5 26 Z" fill="#ff9500"/>
        <!-- Mouth -->
        <path d="M20 27 Q22 28.5 24 27" stroke="white" stroke-width="0.8" fill="none"/>
        <!-- Whiskers -->
        <path d="M7 24.5 L14.5 23.5 M7 26.5 L14.5 25.5" stroke="white" stroke-width="0.8" opacity="0.7"/>
        <path d="M37 24.5 L29.5 23.5 M37 26.5 L29.5 25.5" stroke="white" stroke-width="0.8" opacity="0.7"/>
        <!-- Chart wave at bottom -->
        <path d="M10 34 L14 30 L18 33 L22 28 L26 31 L30 27 L34 29" stroke="#ffdd00" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <div class="brand-text">
        <span class="brand-name">MEWC Trading</span>
        <span class="brand-sub">Market Making Dashboard</span>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <span id="lastUpdate" class="small-muted" style="font-family:var(--mono);font-size:.72rem">—</span>
      <button class="mini-btn" onclick="update(true)"><i class="fas fa-rotate"></i> Refresh</button>
    </div>
  </header>

  <!-- ── Status bar ── -->
  <div class="status-bar">
    <div class="status-pill">
      <div id="statusIndicator" class="bot-dot"></div>
      <span id="statusText">OFFLINE</span>
    </div>
    <div class="status-pill sep"></div>
    <div class="status-pill">
      <i class="fas fa-rotate" style="color:var(--accent);font-size:.72rem"></i>
      Cycle: <strong id="botCycle">—</strong>
    </div>
    <div class="status-pill sep"></div>
    <div class="status-pill" style="max-width:400px;overflow:hidden">
      <span id="botSummary" class="small-muted" style="font-family:var(--mono);font-size:.72rem;white-space:nowrap">No data</span>
    </div>
    <div class="status-pill" style="margin-left:auto;gap:6px">
      <span class="small-muted">Refresh:</span>
      <select id="refreshSelect" class="refresh-select">
        <option value="5000">5s</option>
        <option value="10000">10s</option>
        <option value="30000">30s</option>
        <option value="60000">1 min</option>
      </select>
    </div>
    <div class="status-pill">
      <span id="countdown" style="font-family:var(--mono);color:var(--accent);font-weight:600;font-size:.8rem">5s</span>
    </div>
    <div class="countdown-track" style="flex-basis:100%;margin-top:2px">
      <div id="countdownFill" class="countdown-fill"></div>
    </div>
  </div>

  <!-- ── Tabs ── -->
  <nav class="tabs">
    <button class="tab-btn active" data-tab="overview"><i class="fas fa-gauge-high"></i> Overview</button>
    <button class="tab-btn" data-tab="trading"><i class="fas fa-bolt"></i> Trading</button>
    <button class="tab-btn" data-tab="pnl"><i class="fas fa-chart-line"></i> P&L</button>
    <button class="tab-btn" data-tab="risk"><i class="fas fa-shield-halved"></i> Risk</button>
    <button class="tab-btn" data-tab="automation"><i class="fas fa-robot"></i> Automation</button>
    <button class="tab-btn" data-tab="analytics"><i class="fas fa-microscope"></i> Analytics</button>
    <button class="tab-btn" data-tab="backtest"><i class="fas fa-flask"></i> Backtest</button>
  </nav>

  <!-- ══════════════ TAB: OVERVIEW ══════════════ -->
  <div id="tab-overview" class="tab-panel active">

    <!-- Top row: Price + Portfolio + PnL stats -->
    <div class="grid overview-top-row" style="margin-bottom:14px">

      <!-- MEWC Price -->
      <div class="card">
        <div class="card-title"><i class="fas fa-tag"></i> MEWC / USDT</div>
        <div class="price-hero">
          <span class="price-hero-label">Last price</span>
          <div class="price-hero-value" id="price">—</div>
        </div>
        <div id="priceChange" class="price-change" style="margin-bottom:12px">—</div>
        <div class="stat">
          <span class="stat-label"><i class="fas fa-caret-up" style="color:var(--green)"></i> Bid</span>
          <span class="stat-value mono" id="bid">—</span>
        </div>
        <div class="stat">
          <span class="stat-label"><i class="fas fa-caret-down" style="color:var(--red)"></i> Ask</span>
          <span class="stat-value mono" id="ask">—</span>
        </div>
        <div class="stat">
          <span class="stat-label">24h Volume</span>
          <span class="stat-value" id="volume">—</span>
        </div>
      </div>

      <!-- Portfolio -->
      <div class="card">
        <div class="card-title"><i class="fas fa-wallet"></i> Portfolio</div>
        <!-- MEWC -->
        <div class="portfolio-row">
          <div class="coin-icon mewc">
            <svg viewBox="0 0 20 20" width="16" height="16">
              <path d="M3 13V7l3.5 3.5L10 7l3.5 3.5L17 7v6" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <span class="portfolio-name" style="color:var(--accent)">MEWC</span>
          <span class="portfolio-amount" id="mewcBalance">—</span>
          <span class="portfolio-value" id="mewcValue">—</span>
        </div>
        <!-- USDT -->
        <div class="portfolio-row">
          <div class="coin-icon usdt">
            <svg viewBox="0 0 20 20" width="16" height="16">
              <path d="M10 4v12M6 7h8M7 10h6" stroke="#fff" stroke-width="1.8" fill="none" stroke-linecap="round"/>
            </svg>
          </div>
          <span class="portfolio-name" style="color:#26c99e">USDT</span>
          <span class="portfolio-amount" id="usdtBalance">—</span>
          <span class="portfolio-value" id="usdtValue">—</span>
        </div>
        <div class="separator"></div>
        <div class="stat">
          <span class="stat-label">Total Value</span>
          <span class="num-md" id="totalValue">—</span>
        </div>
        <div class="stat">
          <span class="stat-label">P&L since 07:00</span>
          <span class="stat-value" id="portfolioPnL">—</span>
        </div>
      </div>

      <!-- Daily PnL -->
      <div class="card">
        <div class="card-title"><i class="fas fa-sun"></i> Daily</div>
        <div class="num-xl" id="pnlDaily">—</div>
        <div class="stat" style="margin-top:10px"><span class="stat-label">Trades</span><span class="stat-value" id="tradesDaily">—</span></div>
      </div>

      <!-- Weekly PnL -->
      <div class="card">
        <div class="card-title"><i class="fas fa-calendar-week"></i> Weekly</div>
        <div class="num-xl" id="pnlWeekly">—</div>
        <div class="stat" style="margin-top:10px"><span class="stat-label">Trades</span><span class="stat-value" id="tradesWeekly">—</span></div>
      </div>

      <!-- Monthly PnL -->
      <div class="card">
        <div class="card-title"><i class="fas fa-calendar"></i> Monthly</div>
        <div class="num-xl" id="pnlMonthly">—</div>
        <div class="stat" style="margin-top:10px"><span class="stat-label">Trades</span><span class="stat-value" id="tradesMonthly">—</span></div>
      </div>

      <!-- Win Rate -->
      <div class="card">
        <div class="card-title"><i class="fas fa-trophy"></i> Win Rate</div>
        <div class="num-xl" id="winRate">—</div>
        <div class="stat" style="margin-top:10px"><span class="stat-label">Total</span><span class="stat-value" id="totalTrades">—</span></div>
      </div>

    </div>

    <!-- Chart + Orderbook + Orders -->
    <div class="grid row-3" style="margin-bottom:14px">
      <div class="card">
        <div class="card-title"><i class="fas fa-chart-area"></i> Portfolio History</div>
        <div class="chart-wrap"><canvas id="portfolioChart"></canvas></div>
      </div>
      <div class="grid" style="grid-template-columns:1fr 1fr;gap:14px">
        <div class="card">
          <div class="card-title"><i class="fas fa-layer-group"></i> Orderbook</div>
          <div id="orderbookLadder" class="ladder"></div>
        </div>
        <div class="card">
          <div class="card-title"><i class="fas fa-list"></i> Open Orders</div>
          <div id="ordersList" class="scroll-box"></div>
        </div>
      </div>
    </div>

    <!-- Trades + Errors -->
    <div class="grid row-4">
      <div class="card">
        <div class="card-title"><i class="fas fa-receipt"></i> Recent Trades</div>
        <div class="scroll-box">
          <table class="trades-table">
            <thead><tr><th>Time</th><th>Side</th><th>Qty</th><th>Price</th><th>P&L</th></tr></thead>
            <tbody id="tradesTable"></tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <div class="card-title"><i class="fas fa-triangle-exclamation" style="color:var(--red)"></i> Errors</div>
        <div id="errorsList" class="scroll-box"></div>
      </div>
    </div>

  </div><!-- /tab-overview -->

  <!-- ══════════════ TAB: TRADING ══════════════ -->
  <div id="tab-trading" class="tab-panel">
    <div class="grid row-2-even">

      <div class="card">
        <div class="card-title"><i class="fas fa-terminal"></i> Manual Order</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <select id="manualSide"><option>BUY</option><option>SELL</option></select>
          <select id="manualType"><option>MARKET</option><option>LIMIT</option></select>
        </div>
        <input id="manualQty" class="input" type="number" step="0.0001" placeholder="Quantity (MEWC)" />
        <div class="quick-row">
          <button class="chip" onclick="setQuickQty(25)">25%</button>
          <button class="chip" onclick="setQuickQty(50)">50%</button>
          <button class="chip" onclick="setQuickQty(75)">75%</button>
          <button class="chip" onclick="setQuickQty(100)">100%</button>
        </div>
        <input id="manualPrice" class="input" type="number" step="0.00000001" placeholder="Limit price" disabled />
        <label class="inline-check"><input id="manualReduceOnly" type="checkbox" /> Reduce-only</label>
        <label class="inline-check"><input id="manualConfirmMode" type="checkbox" /> Confirm mode</label>
        <div id="manualValidation" class="small-muted" style="min-height:18px;margin:6px 0"></div>
        <div class="btn-row">
          <button class="btn success" onclick="submitManualOrder()"><i class="fas fa-paper-plane"></i> Submit</button>
          <button id="btnCancelAll" class="btn danger" onclick="cancelAllOrders()"><i class="fas fa-xmark"></i> Cancel all</button>
          <button id="btnSyncTrades" class="btn" onclick="syncTradesFromExchange()"><i class="fas fa-arrows-rotate"></i> Sync</button>
        </div>
        <div id="manualOrderResult" class="small-muted" style="margin-top:10px;font-family:var(--mono);font-size:.72rem;word-break:break-all;min-height:20px"></div>
      </div>

      <div class="card">
        <div class="card-title"><i class="fas fa-robot"></i> Bot Status</div>
        <div class="stat"><span class="stat-label">Connection</span>
          <span class="stat-value" style="display:flex;align-items:center;gap:7px">
            <span id="statusIndicator2" class="bot-dot"></span><span id="statusText2">—</span>
          </span>
        </div>
        <div class="stat"><span class="stat-label">Last cycle</span><span class="stat-value" id="botCycle2">—</span></div>
        <div class="stat"><span class="stat-label">Mid price</span><span class="stat-value mono" id="botMid">—</span></div>
        <div class="stat"><span class="stat-label">Skew</span><span class="stat-value mono" id="botSkew">—</span></div>
        <div class="stat"><span class="stat-label">Active bids</span><span class="stat-value positive" id="botBids">—</span></div>
        <div class="stat"><span class="stat-label">Active asks</span><span class="stat-value negative" id="botAsks">—</span></div>
        <div class="separator"></div>
        <div class="card-title"><i class="fas fa-star"></i> Profit Factor</div>
        <div class="num-lg" id="livePf">—</div>
      </div>

    </div>
  </div><!-- /tab-trading -->

  <!-- ══════════════ TAB: P&L ══════════════ -->
  <div id="tab-pnl" class="tab-panel">
    <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center">
      <span class="small-muted">Window:</span>
      <button class="chip" onclick="setPnlFilter('today')">Today</button>
      <button class="chip" onclick="setPnlFilter('7d')">7d</button>
      <button class="chip" onclick="setPnlFilter('30d')">30d</button>
      <select id="pnlSymbol" class="refresh-select" style="margin-left:10px"><option value="MEWC_USDT">MEWC/USDT</option></select>
      <select id="pnlStrategy" class="refresh-select"><option value="default">Default strategy</option></select>
    </div>
    <div class="grid row-2-even">
      <div class="card">
        <div class="card-title"><i class="fas fa-bolt"></i> Live P&L</div>
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:14px">
          <div><div class="small-muted" style="margin-bottom:4px">Unrealized</div><div class="num-lg" id="liveUnrealized">—</div></div>
          <div><div class="small-muted" style="margin-bottom:4px">Realized</div><div class="num-lg" id="liveRealized">—</div></div>
          <div><div class="small-muted" style="margin-bottom:4px">Fees</div><div class="num-md" id="liveFees">—</div></div>
          <div><div class="small-muted" style="margin-bottom:4px">Net profit</div><div class="num-lg" id="liveNetProfit">—</div></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title"><i class="fas fa-chart-line"></i> Equity Curve</div>
        <div class="chart-wrap"><canvas id="intradayCurve"></canvas></div>
      </div>
    </div>
  </div><!-- /tab-pnl -->

  <!-- ══════════════ TAB: RISK ══════════════ -->
  <div id="tab-risk" class="tab-panel">
    <div class="grid row-2">
      <div class="card">
        <div class="card-title"><i class="fas fa-sliders"></i> Inventory</div>
        <div id="riskInventoryMeter"></div>
        <div id="riskExposureMeter"></div>
        <div class="stat"><span class="stat-label">Inventory ratio</span><span class="stat-value" id="riskInventory">—</span></div>
        <div class="stat"><span class="stat-label">Target ratio</span><span class="stat-value" id="riskTarget">—</span></div>
        <div class="stat"><span class="stat-label">Skew</span><span class="stat-value mono" id="riskSkew">—</span></div>
      </div>
      <div class="card">
        <div class="card-title"><i class="fas fa-shield-halved"></i> Drawdown</div>
        <div class="stat"><span class="stat-label">Session DD</span><span class="stat-value" id="riskDrawdown">—</span></div>
        <div class="stat"><span class="stat-label">Day DD</span><span class="stat-value" id="riskDayDd">—</span></div>
        <div class="stat"><span class="stat-label">Week DD</span><span class="stat-value" id="riskWeekDd">—</span></div>
        <div class="stat"><span class="stat-label">Exposure</span><span class="stat-value" id="riskExposure">—</span></div>
        <div class="stat"><span class="stat-label">Hard limit guard</span><span class="stat-value" id="riskGuard">—</span></div>
        <div class="stat"><span class="stat-label">Risk state</span><span class="stat-value" id="riskState">—</span></div>
      </div>
      <div class="card">
        <div class="card-title"><i class="fas fa-stopwatch"></i> Execution Quality</div>
        <div class="stat"><span class="stat-label">Total fills</span><span class="stat-value" id="execFills">—</span></div>
        <div class="stat"><span class="stat-label">Positive sells</span><span class="stat-value positive" id="execPositive">—</span></div>
        <div class="stat"><span class="stat-label">Negative sells</span><span class="stat-value negative" id="execNegative">—</span></div>
        <div class="stat"><span class="stat-label">Avg P&L/sell</span><span class="stat-value" id="execAvgPnl">—</span></div>
      </div>
      <div class="card">
        <div class="card-title"><i class="fas fa-clock"></i> Lifecycle Metrics</div>
        <div class="stat"><span class="stat-label">p50/p95/p99</span><span class="stat-value mono" id="execPercentiles">—</span></div>
        <div class="stat"><span class="stat-label">Post→Ack avg</span><span class="stat-value" id="execPostAck">—</span></div>
        <div class="stat"><span class="stat-label">Ack→Fill avg</span><span class="stat-value" id="execAckFill">—</span></div>
        <div class="stat"><span class="stat-label">Lifetime avg</span><span class="stat-value" id="execLifetime">—</span></div>
        <div id="execHistogram" class="scroll-box" style="max-height:100px;margin-top:8px"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title"><i class="fas fa-timeline"></i> Lifecycle Events</div>
      <div id="lifecycleList" class="scroll-box"></div>
    </div>
  </div><!-- /tab-risk -->

  <!-- ══════════════ TAB: AUTOMATION ══════════════ -->
  <div id="tab-automation" class="tab-panel">
    <div class="grid row-2-even">
      <div class="card">
        <div class="card-title"><i class="fas fa-list-check"></i> Active Rules</div>
        <div id="automationRules" class="scroll-box" style="max-height:280px;margin-bottom:16px"></div>
        <div class="separator"></div>
        <div class="card-title" style="margin-top:10px"><i class="fas fa-plus"></i> Quick Add</div>
        <input id="ruleName" class="input" placeholder="Rule name" />
        <input id="ruleCondition" class="input" placeholder="Condition: spread_pct > 0.6" />
        <input id="ruleAction" class="input" placeholder="Action: pause_quotes" />
        <button class="btn" onclick="addAutomationRule()"><i class="fas fa-plus"></i> Add</button>
      </div>
      <div class="card">
        <div class="card-title"><i class="fas fa-code-branch"></i> IF / THEN Builder</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <select id="ifType">
            <option value="spread_pct">Spread %</option>
            <option value="inventory_ratio">Inventory ratio</option>
            <option value="session_pnl_usdt">Session PnL</option>
            <option value="daily_pnl_usdt">Daily PnL</option>
          </select>
          <select id="ifOperator">
            <option value=">">&gt;</option><option value="<">&lt;</option>
            <option value=">=">&gt;=</option><option value="<=">&lt;=</option>
          </select>
        </div>
        <input id="ifValue" class="input" type="number" step="any" placeholder="Value" />
        <select id="thenAction">
          <option value="pause_quotes">pause_quotes</option>
          <option value="reduce_size_50pct">reduce_size_50pct</option>
          <option value="stop_bot">stop_bot</option>
          <option value="alert_only">alert_only</option>
        </select>
        <select id="ruleWindow" style="margin-top:8px">
          <option value="always">Always</option>
          <option value="market_hours">Market hours</option>
          <option value="off_hours">Off hours</option>
        </select>
        <button class="btn" style="margin-top:10px" onclick="addBuilderRule()">
          <i class="fas fa-code-branch"></i> Add IF/THEN
        </button>
      </div>
    </div>
  </div><!-- /tab-automation -->

  <!-- ══════════════ TAB: ANALYTICS ══════════════ -->
  <div id="tab-analytics" class="tab-panel">
    <div class="grid row-2-even">
      <div class="card">
        <div class="card-title"><i class="fas fa-scroll"></i> Strategy Journal</div>
        <div id="journalList" class="scroll-box"></div>
      </div>
      <div class="card">
        <div class="card-title"><i class="fas fa-brain"></i> Reason Trace</div>
        <div id="reasonTraceList" class="scroll-box"></div>
      </div>
    </div>
  </div><!-- /tab-analytics -->

  <!-- ══════════════ TAB: BACKTEST ══════════════ -->
  <div id="tab-backtest" class="tab-panel">
    <div class="grid row-2-even">
      <div class="card">
        <div class="card-title"><i class="fas fa-database"></i> Dataset</div>
        <input id="btDatasetInput" class="input" placeholder="Dataset name" value="manual_dataset" />
        <input id="btCandlesInput" class="input" type="number" placeholder="Candles (0=all)" value="0" />
        <div class="btn-row">
          <button class="btn" onclick="importBacktestData()"><i class="fas fa-upload"></i> Import</button>
          <button class="btn" onclick="compareConfigs()"><i class="fas fa-scale-balanced"></i> A/B Compare</button>
        </div>
        <div id="btCompare" class="small-muted" style="margin-top:10px;font-family:var(--mono)"></div>
      </div>
      <div class="card">
        <div class="card-title"><i class="fas fa-chart-bar"></i> Results</div>
        <div class="stat"><span class="stat-label">Dataset</span><span class="stat-value" id="btDataset">—</span></div>
        <div class="stat"><span class="stat-label">Trades</span><span class="stat-value" id="btTrades">—</span></div>
        <div class="stat"><span class="stat-label">Net PnL</span><span class="stat-value" id="btPnl">—</span></div>
        <div class="stat"><span class="stat-label">Profit factor</span><span class="stat-value" id="btPf">—</span></div>
        <div class="stat"><span class="stat-label">Max drawdown</span><span class="stat-value negative" id="btDd">—</span></div>
        <div class="stat"><span class="stat-label">Replay ready</span><span class="stat-value" id="btReady">—</span></div>
      </div>
    </div>
  </div><!-- /tab-backtest -->

</div><!-- /app-wrapper -->

<!-- Modal -->
<div id="modalOverlay" class="modal-overlay">
  <div class="modal">
    <h3 id="modalTitle"></h3>
    <div id="modalBody"></div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Scripts -->
<script src="/static/js/fx.js"></script>
<script src="/static/js/app.js"></script>

</body>
</html>